---
- hosts: dokku
  vars:
    apps:
      - name: top10-api
        static: no
      - name: top10
        static: yes
        port: 80
    dokku_version: v0.23.4
    public_keys:
      - id: admin
        key: "{{ admin_public_key }}"
      - id: deploy
        key: "{{ git_public_key }}"
  remote_user: "{{ admin_username }}"
  roles:
    - print_affected_hosts
    - install_dokku
    - configure_dokku_apps
  tasks:
  - name: Install dokku-dockerfile plugin
    become: yes
    command: dokku plugin:install https://github.com/mimischi/dokku-dockerfile.git
    args:
      creates: /var/lib/dokku/plugins/available/dockerfile
  - name: Configure dokku-dockerfile plugin
    command: dokku dockerfile:set top10-api back-end/dockerfiles/deploy/Dockerfile

  - name: Install dokku-postgres plugin
    become: yes
    command: dokku plugin:install https://github.com/dokku/dokku-postgres.git
    args:
      creates: /var/lib/dokku/plugins/available/postgres
  - name: Create services via dokku-postgres plugin
    command: dokku postgres:create {{ item.name }} -p {{ item.password }}
    args:
      creates: /var/lib/dokku/services/postgres/{{ item.name }}
    with_items: "{{ databases }}"
  - name: Link missing services via dokku-postgres plugin
    command: dokku postgres:link {{ item.name }} {{ item.app }}
    ignore_errors: yes
    with_items: "{{ databases }}"

  - name: Install dokku-letsencrypt plugin
    become: yes
    command: dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git
    args:
      creates: /var/lib/dokku/plugins/available/letsencrypt
